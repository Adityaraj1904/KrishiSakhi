<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiSakhi Chatbot</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <style>
        .voice-controls { margin-top: 20px; }
        #audioPlayer { display: none; margin-top: 10px; }
    </style>
    
</head>
<body>
    <div class="chat-container">
        <h2>Welcome to KrishiSakhi üå±</h2>
        <div id="chat-box"></div>
        <div class="input-container">üéôÔ∏è
            <input type="text" id="user-input" placeholder="Ask me anything about farming... ‡¥ï‡µÉ‡¥∑‡¥ø‡¥Ø‡µÜ‡¥ï‡µç‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥é‡¥®‡µç‡¥§‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡¥≤‡µÅ‡¥Ç ‡¥™‡¥±‡¥Ø‡¥æ‡¥Æ‡µã...">
            <button onclick="sendMessage()">Send</button>
        </div>
        <!-- <div class="voice-controls">
            <button id="recordBtn">üé§ Start Recording</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
            <span id="voiceStatus"></span>
            <audio id="audioPlayer" controls></audio>
        </div> -->
    </div>

    <script>
        // On page load, show the greeting message
        window.onload = function() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML += `
                <div class='bot-message'>
                    <div>Hi, Welcome to KrishiSakhi üå±.<br>How can i help you today?</div> <br>
                    <div>‡¥π‡¥æ‡¥Ø‡µç, ‡¥ï‡µÉ‡¥∑‡¥ø ‡¥∏‡¥ñ‡¥ø‡¥Ø‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µç‡¥µ‡¥æ‡¥ó‡¥§‡¥Ç üå±.<br>‡¥á‡¥®‡µç‡¥®‡µç ‡¥û‡¥æ‡µª ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÜ ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç?</div>
                </div>`;
        }

        // Handle sending messages
        function sendMessage() {
            const userInput = document.getElementById('user-input').value;
            if (userInput.trim() === '') return;

            // Append user's message
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML += `
                <div class='user-message'>
                    <div>${userInput}</div>
                </div>`;

            // Show "thinking..." message
            const thinkingMessage = document.createElement('div');
            thinkingMessage.className = 'bot-message';
            thinkingMessage.id = 'thinking';
            thinkingMessage.innerHTML = `<div><i>ü§î KrishiSakhi is thinking...</i></div>`;
            chatBox.appendChild(thinkingMessage);

            // Call the backend API
            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `text=${userInput}`
            })
            .then(response => response.json())
            .then(data => {
                chatBox.removeChild(thinkingMessage);
                const formattedText = data.text.replace(/\*/g, '').replace(/\n/g, '<br>');
                chatBox.innerHTML += `
                    <div class='bot-message'>
                        <div>${formattedText}</div>
                    </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            document.getElementById('user-input').value = '';
        }

        // Voice chat logic
        let mediaRecorder, audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const audioPlayer = document.getElementById('audioPlayer');
        const chatBox = document.getElementById('chat-box');

        recordBtn.onclick = async () => {
            audioChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            voiceStatus.textContent = "Recording...";
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            voiceStatus.textContent = "Processing...";
            mediaRecorder.onstop = async () => {
                // Send as webm (default browser format)
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob, 'input.webm');
                // Show "thinking..." message
                const thinkingMessage = document.createElement('div');
                thinkingMessage.className = 'bot-message';
                thinkingMessage.id = 'thinking';
                thinkingMessage.innerHTML = `<div><i>ü§î KrishiSakhi is thinking...</i></div>`;
                chatBox.appendChild(thinkingMessage);

                const res = await fetch('/voice', { method: 'POST', body: formData });
                const data = await res.json();
                chatBox.removeChild(thinkingMessage);
                const formattedText = data.text.replace(/\*/g, '').replace(/\n/g, '<br>');
                chatBox.innerHTML += `
                    <div class='user-message'>
                        <div><i>(Voice message sent)</i></div>
                    </div>
                    <div class='bot-message'>
                        <div>${formattedText}</div>
                    </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                voiceStatus.textContent = "";
                if (data.audio_url) {
                    audioPlayer.src = data.audio_url;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play();
                }
            };
        };
    </script>
</body>
</html>